#!/bin/bash
# My Workflow Plugin - Capture Agent Results
# Triggered by SubagentStop events
# Captures summaries and outcomes from agent work

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/hook-utils.sh"

debug_log "capture-agent-result.sh triggered"

# Get agent output from environment
AGENT_OUTPUT="${CLAUDE_TOOL_OUTPUT:-}"

if [[ -z "$AGENT_OUTPUT" ]]; then
    debug_log "No agent output to analyze"
    exit 0
fi

debug_log "Agent output length: ${#AGENT_OUTPUT}"

# Ensure database exists
DB=$(ensure_db)
if [[ -z "$DB" ]]; then
    debug_log "Database not initialized"
    exit 0
fi

PROJECT=$(get_project_name)
SESSION_ID=$(get_current_session_id)

# ============================================================================
# Extract Agent Work Summary
# ============================================================================

# Look for key outcomes in agent output
SUMMARY_PATTERNS=(
    "completed"
    "finished"
    "created"
    "implemented"
    "fixed"
    "resolved"
    "found"
    "discovered"
    "analyzed"
    "reviewed"
)

WORK_SUMMARY=""
for pattern in "${SUMMARY_PATTERNS[@]}"; do
    MATCHES=$(echo "$AGENT_OUTPUT" | grep -i "$pattern" | head -5)
    if [[ -n "$MATCHES" ]]; then
        WORK_SUMMARY="$MATCHES"
        debug_log "Found agent work pattern: $pattern"
        break
    fi
done

# ============================================================================
# Capture Decisions from Agent Work
# ============================================================================

if is_enabled "decisions"; then
    DECISION_PATTERNS=(
        "decided to "
        "chose to "
        "selected "
        "using .* because"
        "implemented with "
        "the approach "
    )

    for pattern in "${DECISION_PATTERNS[@]}"; do
        if echo "$AGENT_OUTPUT" | grep -Eqi "$pattern"; then
            CONTEXT=$(echo "$AGENT_OUTPUT" | grep -Ei "$pattern" | head -3)

            if [[ -n "$CONTEXT" && ${#CONTEXT} -gt 20 ]]; then
                TITLE=$(echo "$CONTEXT" | head -1 | cut -c1-100 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')

                SIMILAR=$(sqlite3 "$DB" "
                    SELECT COUNT(*)
                    FROM decisions
                    WHERE project = '$PROJECT'
                      AND title LIKE '%$(echo "$TITLE" | cut -c1-30 | sed "s/'/''/g")%'
                      AND created_at > datetime('now', '-30 minutes')
                " 2>/dev/null || echo "0")

                if [[ "$SIMILAR" -eq 0 ]]; then
                    DECISION_ID=$(get_next_id "decisions" "D")
                    ESCAPED_TITLE=$(sql_escape "$TITLE")
                    ESCAPED_CONTEXT=$(sql_escape "$CONTEXT")

                    db_exec "INSERT INTO decisions (
                        id, title, description, category,
                        project, source_session_id, source_context, status
                    ) VALUES (
                        '$DECISION_ID', '$ESCAPED_TITLE', '$ESCAPED_CONTEXT', 'agent-decision',
                        '$PROJECT', '$SESSION_ID', 'agent-output', 'active'
                    )"

                    activity_log "decision" "Agent decision: $TITLE" "decisions" "$DECISION_ID" "$PROJECT" "{\"source\":\"agent\"}"
                    debug_log "Created agent decision $DECISION_ID: $TITLE"
                fi
            fi
            break
        fi
    done
fi

# ============================================================================
# Capture Implementation Notes
# ============================================================================

# Look for file changes or implementations
FILE_PATTERNS=$(echo "$AGENT_OUTPUT" | grep -Eo "[a-zA-Z0-9_/-]+\.(ts|js|py|php|sh|json|md)" | sort -u | head -10)

if [[ -n "$FILE_PATTERNS" && -n "$WORK_SUMMARY" ]]; then
    debug_log "Agent worked on files: $FILE_PATTERNS"

    # Log agent work to activity
    WORK_TITLE=$(echo "$WORK_SUMMARY" | head -1 | cut -c1-80)
    activity_log "agent-work" "$WORK_TITLE" "session" "$SESSION_ID" "$PROJECT" "{\"files\":\"$FILE_PATTERNS\"}"
fi

# ============================================================================
# Capture Ideas Generated by Agent
# ============================================================================

if is_enabled "ideas"; then
    IDEA_PATTERNS=(
        "could also "
        "might want to "
        "consider "
        "suggestion: "
        "alternatively "
        "future improvement "
        "TODO: "
    )

    for pattern in "${IDEA_PATTERNS[@]}"; do
        if echo "$AGENT_OUTPUT" | grep -qi "$pattern"; then
            CONTEXT=$(echo "$AGENT_OUTPUT" | grep -i "$pattern" | head -2)

            if [[ -n "$CONTEXT" && ${#CONTEXT} -gt 20 ]]; then
                TITLE=$(echo "$CONTEXT" | head -1 | cut -c1-100 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')

                SIMILAR=$(sqlite3 "$DB" "
                    SELECT COUNT(*)
                    FROM ideas
                    WHERE project = '$PROJECT'
                      AND title LIKE '%$(echo "$TITLE" | cut -c1-30 | sed "s/'/''/g")%'
                      AND created_at > datetime('now', '-30 minutes')
                " 2>/dev/null || echo "0")

                if [[ "$SIMILAR" -eq 0 ]]; then
                    IDEA_ID=$(get_next_id "ideas" "I")
                    ESCAPED_TITLE=$(sql_escape "$TITLE")
                    ESCAPED_CONTEXT=$(sql_escape "$CONTEXT")

                    db_exec "INSERT INTO ideas (
                        id, title, description, category,
                        project, source_session_id, status
                    ) VALUES (
                        '$IDEA_ID', '$ESCAPED_TITLE', '$ESCAPED_CONTEXT', 'agent-suggestion',
                        '$PROJECT', '$SESSION_ID', 'inbox'
                    )"

                    activity_log "idea" "Agent suggestion: $TITLE" "ideas" "$IDEA_ID" "$PROJECT" "{\"source\":\"agent\"}"
                    debug_log "Created agent idea $IDEA_ID: $TITLE"
                fi
            fi
            break
        fi
    done
fi

exit 0
